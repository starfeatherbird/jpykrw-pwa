<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>엔 ↔ 원 계산기 & 패키지 가치</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1976d2">
  <link rel="icon" href="icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Apple SD Gothic Neo, sans-serif; }
    body { margin: 0; padding: 24px; background: #fafafa; color: #222; }
    .card { max-width: 820px; margin: 0 auto; background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 6px 20px rgba(0,0,0,.08); }
    h1 { font-size: 20px; margin: 0 0 12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .pill { font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid #ddd; background: #f7f7f7; }
    .tabs { display:flex; gap:8px; margin: 8px 0 12px; flex-wrap:wrap; }
    .tabbtn { padding:8px 12px; border:1px solid #ddd; background:#fff; border-radius:10px; cursor:pointer; }
    .tabbtn.active { background:#eaf2ff; border-color:#b6d0ff; }
    .section { display:none; }
    .section.active { display:block; }
    .row { display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin:12px 0; }
    .full { grid-column: 1 / -1; }
    label { font-size:12px; color:#555; margin-bottom:6px; display:block; }
    input, select { width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; font-size:16px; background:#fff; box-sizing:border-box; }
    .out { background:#f5f7fa; }
    .btn { padding:10px 14px; border:1px solid #ddd; background:#fff; border-radius:10px; cursor:pointer; white-space:nowrap; }
    .btn:active { transform: translateY(1px); }
    .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .muted { color:#666; font-size:12px; }
    .kpi { display:flex; gap:12px; flex-wrap:wrap; margin-top:8px;}
    .kpi > div { background:#f6f8fa; border:1px solid #eee; border-radius:10px; padding:10px 12px; font-size:13px; }
    .flag { padding:2px 6px; border-radius:999px; border:1px solid #ddd; font-size:12px; }
    .good { background:#e8f5e9; }
    .warn { background:#fff8e1; }
    .bad  { background:#ffebee; }
    @media (max-width:480px){ .row{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <div class="card">
    <h1>엔 ↔ 원 계산기 <span class="pill">PWA · 실시간 환율</span><span class="pill">패키지 가치</span></h1>

    <!-- 탭 버튼 -->
    <div class="tabs">
      <button class="tabbtn active" data-tab="fx">환율 계산</button>
      <button class="tabbtn" data-tab="pkg">패키지 계산</button>
    </div>

    <!-- 공통: 환율 영역(두 탭이 공유) -->
    <div class="row">
      <div>
        <label>환율 (원/엔)</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <input id="rate" type="text" placeholder="예: 9.50" inputmode="decimal" style="flex:1 1 60%;" />
          <button class="btn" id="fetchBtn" type="button">실시간 환율</button>
        </div>
        <div class="muted">예: 1 JPY = 9.50 KRW 라면 9.50 입력 · <span id="lastUpdated">업데이트 시각: -</span></div>
      </div>
      <div class="full"></div>
    </div>

    <!-- 탭 1: 환율 계산 -->
    <section id="tab-fx" class="section active">
      <div class="row">
        <div>
          <label>방향</label>
          <select id="direction">
            <option value="jpy2krw">엔 ➜ 원 (JPY → KRW)</option>
            <option value="krw2jpy">원 ➜ 엔 (KRW → JPY)</option>
          </select>
        </div>
        <div>
          <label>반올림 자릿수</label>
          <select id="decimals">
            <option value="0">0자리</option>
            <option value="1" selected>1자리</option>
            <option value="2">2자리</option>
            <option value="3">3자리</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>금액 <span id="amtLabel">(엔)</span></label>
          <input id="amount" type="text" placeholder="예: 10,000" inputmode="decimal" />
        </div>
        <div>
          <label>수수료(%) — 선택</label>
          <input id="fee" type="text" placeholder="예: 1.8" inputmode="decimal" />
          <div class="muted">환전/카드 스프레드가 있다면 입력(없으면 비워두기)</div>
        </div>
        <div class="full">
          <label>결과</label>
          <input id="result" class="out" type="text" readonly />
          <div class="actions">
            <button class="btn" id="copyBtn">결과 복사</button>
            <button class="btn" id="swapBtn">방향 바꾸기</button>
            <button class="btn" id="resetBtn">초기화</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 탭 2: 패키지 계산 -->
    <section id="tab-pkg" class="section">
      <div class="row">
        <div>
          <label>정가 기준 <b>최저 1개당 가격</b> (￥)</label>
          <input id="baselinePpu" type="text" placeholder="예: 58.82 (85개/￥5000 기준)" inputmode="decimal" />
          <div class="muted">정가표를 쓰지 않고 “최저 1개당 가격”만 입력합니다.</div>
        </div>
        <div class="full"></div>
      </div>

      <div class="row">
        <div>
          <label>패키지 가격 (￥)</label>
          <input id="pkgPrice" type="text" placeholder="예: 2400" inputmode="decimal" />
        </div>
        <div>
          <label>포함 개수 (엔석 개수)</label>
          <input id="pkgQty" type="text" placeholder="예: 20" inputmode="decimal" />
        </div>
        <div>
          <label>추가 보상 추정가 (￥) — 선택</label>
          <input id="pkgExtras" type="text" placeholder="예: 0 (확정 캐릭/티켓 가치)" inputmode="decimal" />
        </div>
      </div>

      <div class="kpi">
        <div><b>정가 최저 1개당</b> : <span id="vBasePpu">-</span> ￥</div>
        <div><b>패키지 1개당 실효가</b> : <span id="vEffPpu">-</span> ￥ <span class="muted">(=(가격-추정가)/개수)</span></div>
        <div><b>절감액</b> : <span id="vSaveAbs">-</span> ￥ / <span id="vSavePct">-</span>% <span id="flag" class="flag"></span></div>
      </div>
      <div class="kpi">
        <div><b>원화 기준</b> : 정가 <span id="vBasePpuKrw">-</span>원 vs 패키지 <span id="vEffPpuKrw">-</span>원 (1개당)</div>
      </div>

      <p class="muted">
        • “추가 보상 추정가”를 0으로 두면 순수 개수만 비교합니다. 값을 넣으면 그만큼 패키지 가격에서 차감해 실효가를 계산합니다.<br/>
        • 위 환율(원/엔)을 공유합니다. 실시간 버튼으로 갱신 후 비교하면 원화 기준도 즉시 반영됩니다.
      </p>
    </section>

    <p class="muted">실시간 환율: exchangerate.host → 실패 시 open.er-api.com → 둘 다 실패 시 allorigins.win 순으로 시도합니다. 오프라인 시 마지막 상태를 캐시합니다(PWA).</p>
  </div>

  <script>
    /* ========== 탭 전환 ========== */
    const q = (sel)=>document.querySelector(sel);
    const qa = (sel)=>[...document.querySelectorAll(sel)];
    qa('.tabbtn').forEach(b=>b.onclick=()=>{
      qa('.tabbtn').forEach(x=>x.classList.remove('active'));
      qa('.section').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      q('#tab-'+b.dataset.tab).classList.add('active');
    });

    /* ========== 공통: 환율 ========== */
    const rate = q('#rate'), fetchBtn = q('#fetchBtn'), lastUpdated = q('#lastUpdated');
    const pad2 = (n)=> n<10?'0'+n:n;
    const fmtDate = (ts)=>{const d=new Date(ts);return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;}
    const toNum = (v)=> Number(String(v||'').replace(/[,\s]/g,'')) || 0;
    const fmt = (n,d=0)=> isFinite(n) ? Number(n).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d}) : '-';
    function setLastUpdated(ts,src='자동'){ localStorage.setItem('jpy_lastRateUpdatedAt',ts); localStorage.setItem('jpy_lastRateSource',src); lastUpdated.textContent=`업데이트 시각: ${fmtDate(ts)} (${src})`; }
    function loadLastUpdated(){ const ts=localStorage.getItem('jpy_lastRateUpdatedAt'); const s=localStorage.getItem('jpy_lastRateSource')||'자동'; lastUpdated.textContent= ts?`업데이트 시각: ${fmtDate(ts)} (${s})`:'업데이트 시각: -'; }
    async function fetchRateSmart(){
      async function tryUrl(u){ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw 0; const j=await r.json(); const v=j?.rates?.KRW; if(!v) throw 0; return v; }
      try { return await tryUrl('https://api.exchangerate.host/latest?base=JPY&symbols=KRW'); } catch(e){}
      try { return await tryUrl('https://open.er-api.com/v6/latest/JPY'); } catch(e){}
      return await tryUrl('https://api.allorigins.win/raw?url='+encodeURIComponent('https://api.exchangerate.host/latest?base=JPY&symbols=KRW'));
    }
    fetchBtn.onclick=async()=>{
      const t=fetchBtn.textContent; fetchBtn.disabled=true; fetchBtn.textContent='불러오는 중...';
      try{ const v=await fetchRateSmart(); rate.value=Number(v).toFixed(4); localStorage.setItem('jpy_lastRate',rate.value); setLastUpdated(new Date().toISOString(),'자동'); calcFx(); calcPkg(); }
      catch(e){ alert('환율을 가져오지 못했습니다. 네트워크 상태를 확인해주세요.'); }
      fetchBtn.disabled=false; fetchBtn.textContent=t;
    };

    /* ========== 탭1: 환율 계산 ========== */
    const direction=q('#direction'), decimals=q('#decimals'), amount=q('#amount'), fee=q('#fee'), result=q('#result'), amtLabel=q('#amtLabel');
    function updateLabels(){ amtLabel.textContent = (direction.value==='jpy2krw') ? '(엔)' : '(원)'; }
    function calcFx(){
      const r=toNum(rate.value), amt=toNum(amount.value), f=toNum(fee.value)/100, d=+decimals.value;
      if(!(r>0&&amt>0)){ result.value=''; return; }
      const out = (direction.value==='jpy2krw') ? amt*r*(1+(isFinite(f)?f:0)) : amt/r/(1+(isFinite(f)?f:0));
      result.value = `${fmt(out,d)} ${direction.value==='jpy2krw'?'원':'엔'}`;
    }
    [direction,decimals].forEach(e=>e.addEventListener('change',()=>{updateLabels();calcFx();}));
    [amount,fee,rate].forEach(e=>e.addEventListener('input',calcFx));
    q('#copyBtn').onclick=async()=>{ if(!result.value) return; await navigator.clipboard.writeText(result.value); };
    q('#swapBtn').onclick=()=>{ direction.value=(direction.value==='jpy2krw')?'krw2jpy':'jpy2krw'; updateLabels(); calcFx(); };
    q('#resetBtn').onclick=()=>{ amount.value=''; fee.value=''; result.value=''; };

    /* ========== 탭2: 패키지 계산(최저 1개당만 입력) ========== */
    const baselinePpu=q('#baselinePpu'), pkgPrice=q('#pkgPrice'), pkgQty=q('#pkgQty'), pkgExtras=q('#pkgExtras');
    const vBasePpu=q('#vBasePpu'), vEffPpu=q('#vEffPpu'), vSaveAbs=q('#vSaveAbs'), vSavePct=q('#vSavePct'), flag=q('#flag');
    const vBasePpuKrw=q('#vBasePpuKrw'), vEffPpuKrw=q('#vEffPpuKrw');

    function calcPkg(){
      const base = toNum(baselinePpu.value); vBasePpu.textContent = base?fmt(base,2):'-';
      const price = toNum(pkgPrice.value), qty = toNum(pkgQty.value), extras = toNum(pkgExtras.value);
      if(!(base>0 && price>0 && qty>0)){ vEffPpu.textContent=vSaveAbs.textContent=vSavePct.textContent='-'; vBasePpuKrw.textContent=vEffPpuKrw.textContent='-'; flag.textContent=''; flag.className='flag'; return; }
      const eff = (price - extras)/qty; // 실효 1개당
      vEffPpu.textContent = fmt(eff,2);

      const savePer = base - eff;            // 1개당 절감(+이면 이득)
      const saveTot = savePer * qty;
      const pct = (savePer/base)*100;
      vSaveAbs.textContent = fmt(saveTot,0);
      vSavePct.textContent = fmt(pct,1);

      flag.className='flag ' + (savePer>0?'good':(Math.abs(savePer)<=0.01?'warn':'bad'));
      flag.textContent = savePer>0 ? '이득' : (Math.abs(savePer)<=0.01 ? '비슷' : '비효율');

      const r = toNum(rate.value);
      if(r>0){ vBasePpuKrw.textContent = fmt(base*r,0); vEffPpuKrw.textContent = fmt(eff*r,0); }
      else { vBasePpuKrw.textContent = vEffPpuKrw.textContent = '-'; }
    }
    [baselinePpu,pkgPrice,pkgQty,pkgExtras,rate].forEach(el=> el.addEventListener('input', calcPkg));

    /* ========== PWA SW 자동 새로고침 ========== */
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        const reg = await navigator.serviceWorker.register('./sw.js');
        navigator.serviceWorker.addEventListener('message', (evt) => {
          if (evt.data && evt.data.type === 'NEW_VERSION_READY') setTimeout(() => location.reload(), 200);
        });
        navigator.serviceWorker.addEventListener('controllerchange', () => setTimeout(() => location.reload(), 200));
      });
    }

    /* ========== 초기화 ========== */
    (function init(){
      // 환율 복원
      const cached = localStorage.getItem('jpy_lastRate');
      rate.value = cached || '9.5000';
      loadLastUpdated();
      rate.addEventListener('input', ()=>{ localStorage.setItem('jpy_lastRate', rate.value); });

      // 환율 탭 초기 상태
      decimals.value='1'; updateLabels(); calcFx();

      // 패키지 기본값(예: 85개/5000엔 → 58.82)
      if(!localStorage.getItem('base_ppu_default_set')){
        baselinePpu.value = '58.82';
        localStorage.setItem('base_ppu_default_set','1');
      }
      // 입력 변경 시 저장 (선택)
      ['baselinePpu','pkgPrice','pkgQty','pkgExtras'].forEach(id=>{
        const el = q('#'+id); const v = localStorage.getItem('jpy_'+id); if(v) el.value=v;
        el.addEventListener('input', ()=> localStorage.setItem('jpy_'+id, el.value));
      });
      calcPkg();
    })();
  </script>
</body>
</html>

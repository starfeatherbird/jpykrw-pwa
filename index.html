<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>엔 ↔ 원 계산기 (환율 · 패키지 가치)</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1976d2">
  <link rel="icon" href="icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, "Noto Sans KR", sans-serif; }
    body { margin: 0; padding: 24px; background:#fafafa; color:#222; }
    .card { max-width: 680px; margin: 0 auto; background:#fff; border-radius:16px; padding:20px; box-shadow:0 6px 20px rgba(0,0,0,.08); }
    h1 { font-size:20px; margin:0 0 12px; }
    .tabs { display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
    .tabbtn { padding:10px 14px; border:1px solid #ddd; background:#fff; border-radius:10px; cursor:pointer; }
    .tabbtn.active { background:#eaf2ff; border-color:#b6d0ff; }
    .row { display:grid; grid-template-columns:repeat(auto-fit, minmax(220px,1fr)); gap:12px; margin:12px 0; }
    .full { grid-column:1 / -1; }
    label { font-size:12px; color:#555; margin-bottom:6px; display:block; }
    input, select { width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; font-size:16px; background:#fff; box-sizing:border-box; }
    .out { background:#f4f6f8; }
    .btn { padding:10px 14px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; white-space:nowrap; }
    .btn:active { transform: translateY(1px); }
    .actions { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .muted { color:#666; font-size:12px; }
    .note { font-size:12px; color:#555; line-height:1.6; }
    @media (max-width:480px){ .row { grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="card">
    <h1>엔 ↔ 원 계산기 <span class="muted">PWA · 실시간 환율 · 패키지 가치</span></h1>

    <!-- 탭 -->
    <div class="tabs">
      <button class="tabbtn active" data-tab="fx">환율 계산</button>
      <button class="tabbtn" data-tab="pkg">패키지 계산</button>
    </div>

    <!-- 공통: 환율 입력 -->
    <div class="row">
      <div class="full">
        <label>환율 (원/엔)</label>
        <div style="display:flex; gap:8px;">
          <input id="rate" placeholder="예: 9.50" inputmode="decimal" style="flex:1;">
          <button class="btn" id="btnFetch">실시간 환율</button>
        </div>
        <div class="muted">예: 1 JPY = 9.50 KRW 라면 9.50 입력 · <span id="lastUpdated">업데이트 시각: -</span></div>
      </div>
    </div>

    <!-- 환율 계산 섹션 -->
    <section id="tab-fx" style="display:block;">
      <div class="row">
        <div>
          <label>방향</label>
          <select id="direction">
            <option value="jpy2krw">엔 ➜ 원 (JPY → KRW)</option>
            <option value="krw2jpy">원 ➜ 엔 (KRW → JPY)</option>
          </select>
        </div>
        <div>
          <label>반올림 자릿수</label>
          <select id="decimals">
            <option value="0">0자리</option>
            <option value="1" selected>1자리</option>
            <option value="2">2자리</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label>금액 <span id="amtLabel">(엔)</span></label>
          <input id="amount" placeholder="예: 10,000" inputmode="decimal">
        </div>
        <div>
          <label>수수료(%) — 선택</label>
          <input id="fee" placeholder="예: 1.8" inputmode="decimal">
          <div class="muted">환전/카드 스프레드가 있으면 입력(없으면 비우기)</div>
        </div>
        <div class="full">
          <label>결과</label>
          <input id="result" class="out" readonly>
          <div class="actions">
            <button class="btn" id="btnCopy">결과 복사</button>
            <button class="btn" id="btnSwap">방향 바꾸기</button>
            <button class="btn" id="btnReset">초기화</button>
          </div>
        </div>
      </div>
      <p class="note">• 환율은 exchangerate.host → open.er-api.com → allorigins.win 순으로 시도합니다. • 오프라인 시 마지막 성공 값을 캐시합니다.</p>
    </section>

    <!-- 패키지 계산 섹션 -->
    <section id="tab-pkg" style="display:none;">
      <div class="row">
        <div>
          <label>패키지 가격 (¥)</label>
          <input id="pkgPrice" placeholder="예: 2400" inputmode="decimal">
        </div>
        <div>
          <label>유료재화 개수 (마법석)</label>
          <input id="pkgQty" placeholder="예: 20" inputmode="decimal">
        </div>
        <div>
          <label>추가 보상 추정가 (¥) — 선택</label>
          <input id="pkgExtra" placeholder="예: 0 (확정캐릭 가치)" inputmode="decimal">
        </div>
      </div>

      <h3 class="muted" style="margin:8px 0 0;">정가(상시 최저) 기준</h3>
      <div class="row">
        <div>
          <label>최저가 재화 개수</label>
          <input id="baseItems" placeholder="예: 85" value="85" inputmode="numeric">
        </div>
        <div>
          <label>최저가 금액 (¥)</label>
          <input id="basePrice" placeholder="예: 5000" value="5000" inputmode="decimal">
        </div>
        <div class="full">
          <label>정가 기준 1개당 가격 (¥)</label>
          <input id="basePerItem" class="out" readonly>
        </div>
      </div>

      <!-- 결과: JPY -->
      <div class="row full">
        <input id="pkgResult" class="out full" readonly>
      </div>
      <!-- 결과: KRW -->
      <div class="row full">
        <input id="pkgResultKrw" class="out full" readonly>
      </div>

      <p class="note">※ “정가 기준 1개당” = (최저가 금액 ÷ 재화 개수) · “확정 캐릭 추정” = (패키지 가격 − (정가×유료재화 개수))</p>
    </section>
  </div>

  <script>
    /* ===== 유틸 ===== */
    const $  = sel => document.querySelector(sel);
    const $$ = sel => [...document.querySelectorAll(sel)];
    const toNum  = v => Number(String(v||'').replace(/[,\s]/g,'')) || 0;
    const fmtNum = (n,d=0)=> isFinite(n) ? Number(n).toLocaleString(undefined,{minimumFractionDigits:d,maximumFractionDigits:d}) : '-';
    const fmtJPY = (n,d=0)=> `¥ ${fmtNum(n,d)}`;
    const fmtKRW = n => `${fmtNum(Math.round(n),0)}원`;
    const pad2=(n)=>n<10?'0'+n:n, fmtDate=(ts)=>{const d=new Date(ts);return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`};

    /* ===== 탭 전환 ===== */
    $$('.tabbtn').forEach(b=>b.addEventListener('click',()=>{
      $$('.tabbtn').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      $('#tab-fx').style.display = (b.dataset.tab==='fx')?'block':'none';
      $('#tab-pkg').style.display = (b.dataset.tab==='pkg')?'block':'none';
    }));

    /* ===== 환율 가져오기 ===== */
    const rate=$('#rate'), lastUpdated=$('#lastUpdated'), btnFetch=$('#btnFetch');
    function setLast(ts,src='자동'){ localStorage.setItem('jpy_last_at', ts); lastUpdated.textContent=`업데이트 시각: ${fmtDate(ts)} (${src})`; }
    (function(){ const ts=localStorage.getItem('jpy_last_at'); if(ts) lastUpdated.textContent=`업데이트 시각: ${fmtDate(ts)}`; })();

    async function fetchRateSmart(){
      async function tryUrl(u){ const r=await fetch(u,{cache:'no-store'}); if(!r.ok) throw 0; const j=await r.json(); const v=j?.rates?.KRW||j?.KRW; if(!v) throw 0; return v; }
      try { return await tryUrl('https://api.exchangerate.host/latest?base=JPY&symbols=KRW'); } catch(e){}
      try { return await tryUrl('https://open.er-api.com/v6/latest/JPY'); } catch(e){}
      return await tryUrl('https://api.allorigins.win/raw?url='+encodeURIComponent('https://api.exchangerate.host/latest?base=JPY&symbols=KRW'));
    }
    btnFetch.addEventListener('click', async ()=>{
      const t=btnFetch.textContent; btnFetch.disabled=true; btnFetch.textContent='불러오는 중...';
      try { const v=await fetchRateSmart(); rate.value=Number(v).toFixed(4); localStorage.setItem('jpy_rate', rate.value); setLast(new Date().toISOString(),'자동'); calcFx(); calcPkg(); }
      catch{ alert('환율을 가져오지 못했습니다. 네트워크 상태를 확인해주세요.'); }
      btnFetch.disabled=false; btnFetch.textContent=t;
    });
    rate.addEventListener('input', ()=>{ localStorage.setItem('jpy_rate', rate.value); calcFx(); calcPkg(); });

    /* ===== 환율 계산 ===== */
    const direction=$('#direction'), decimals=$('#decimals'), amount=$('#amount'), fee=$('#fee'), result=$('#result'), amtLabel=$('#amtLabel');
    function updateLabels(){ amtLabel.textContent=(direction.value==='jpy2krw')?'(엔)':'(원)'; }
    function calcFx(){
      const r=toNum(rate.value), a=toNum(amount.value), f=toNum(fee.value)/100, d=+decimals.value;
      if(!(r>0 && a>0)){ result.value=''; return; }
      let out = (direction.value==='jpy2krw') ? a*r : a/r;
      if (isFinite(f)) out *= (1 - f); // 수수료 반영(감액)
      result.value = fmtNum(out, d) + (direction.value==='jpy2krw'?' 원':' 엔');
    }
    [direction,decimals].forEach(el=>el.addEventListener('change',()=>{updateLabels();calcFx();}));
    [amount,fee].forEach(el=>el.addEventListener('input',calcFx));
    $('#btnCopy').addEventListener('click', async ()=>{ if(result.value) await navigator.clipboard.writeText(result.value); });
    $('#btnSwap').addEventListener('click', ()=>{ direction.value=(direction.value==='jpy2krw')?'krw2jpy':'jpy2krw'; updateLabels(); calcFx(); });
    $('#btnReset').addEventListener('click', ()=>{ amount.value=''; fee.value=''; result.value=''; });

    /* ===== 패키지 계산 ===== */
    const baseItemsEl=$('#baseItems'), basePriceEl=$('#basePrice'), basePerItemEl=$('#basePerItem');
    const pkgPriceEl=$('#pkgPrice'), pkgQtyEl=$('#pkgQty'), pkgExtraEl=$('#pkgExtra');
    const pkgResultEl=$('#pkgResult'), pkgResultKrwEl=$('#pkgResultKrw');

    function calcPkg(){
      // 정가(상시 최저) 1개당
      const baseItems = toNum(baseItemsEl.value);
      const basePrice = toNum(basePriceEl.value);
      const base = baseItems>0 ? (basePrice/baseItems) : 0;
      basePerItemEl.value = base ? fmtNum(base,2) : '';

      // 입력값
      const price = toNum(pkgPriceEl.value);
      const qty   = toNum(pkgQtyEl.value);
      const extra = toNum(pkgExtraEl.value);
      const r     = toNum(rate.value); // KRW/JPY

      if(!(base>0 && price>0 && qty>0)){
        pkgResultEl.value=''; pkgResultKrwEl.value=''; return;
      }

      // 계산
      const effPer  = (price - extra) / qty;   // 패키지 1개당 실효(JPY)
      const implied = price - (base * qty);    // 확정 캐릭 추정(JPY)

      // JPY 라인 (기호 앞)
      pkgResultEl.value =
        `정가 1개당: ${fmtJPY(base,2)} / ` +
        `패키지 실효가: ${fmtJPY(effPer,2)} / ` +
        `확정캐릭 추정: ${fmtJPY(implied,0)}`;

      // KRW 라인
      if(r>0){
        const baseK = base*r, effK=effPer*r, impK=implied*r;
        pkgResultKrwEl.value =
          `(KRW) 정가 1개당: ${fmtKRW(baseK)} / ` +
          `패키지 실효가: ${fmtKRW(effK)} / ` +
          `확정캐릭 추정: ${fmtKRW(impK)}`;
      } else {
        pkgResultKrwEl.value = '(KRW) 환율을 먼저 입력/갱신해 주세요.';
      }
    }

    [baseItemsEl, basePriceEl, pkgPriceEl, pkgQtyEl, pkgExtraEl].forEach(el=>el.addEventListener('input', calcPkg));
    rate.addEventListener('input', calcPkg);

    // 최초 값
    (function init(){
      rate.value = localStorage.getItem('jpy_rate') || rate.value || '';
      updateLabels(); calcFx(); calcPkg();
    })();

    /* ===== 서비스워커 (자동 업데이트) ===== */
    if('serviceWorker' in navigator){
      window.addEventListener('load', async ()=>{
        const reg = await navigator.serviceWorker.register('./sw.js');
        navigator.serviceWorker.addEventListener('message', e=>{ if(e.data?.type==='NEW_VERSION_READY') setTimeout(()=>location.reload(),200); });
        navigator.serviceWorker.addEventListener('controllerchange', ()=> setTimeout(()=>location.reload(),200));
        reg.update().catch(()=>{}); setInterval(()=>reg.update().catch(()=>{}), 30*60*1000);
      });
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>엔 ↔ 원 계산기 (JPY↔KRW 환율 · 패키지 가치)</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body { font-family: "Segoe UI", sans-serif; background:#fafafa; margin:0; padding:2rem; }
    h1 { font-size:1.8rem; margin-bottom:0.5rem; }
    .tab { margin:1rem 0; }
    .tab button { padding:0.5rem 1rem; border:1px solid #ccc; background:#fff; cursor:pointer; border-radius:5px; }
    .tab button.active { background:#0066cc; color:#fff; }
    .section { display:none; margin-top:1rem; }
    .section.active { display:block; }
    input, select { padding:0.4rem; border:1px solid #ccc; border-radius:5px; }
    .row { margin:0.6rem 0; }
    .kpi { margin-top:1rem; background:#f6f8fa; padding:0.8rem; border-radius:6px; display:flex; flex-wrap:wrap; gap:1rem; }
    .kpi div { padding:0.3rem 0.6rem; background:#fff; border-radius:5px; box-shadow:0 0 2px #ccc; }
    .muted { color:#666; font-size:0.85rem; }
    button { cursor:pointer; }
  </style>
</head>
<body>

  <h1>엔 ↔ 원 계산기 <span class="muted">PWA · 실시간 환율</span> <span class="muted">· 패키지 가치</span></h1>

  <div class="tab">
    <button id="tabExchange" class="active">환율 계산</button>
    <button id="tabPackage">패키지 계산</button>
  </div>

  <!-- 환율 계산 섹션 -->
  <div id="exchangeSection" class="section active">
    <div class="row">
      <label>환율 (원/엔)</label>
      <input id="rate" placeholder="예: 9.50">
      <button onclick="getRate()">실시간 환율</button>
    </div>

    <p class="muted" id="rateInfo">예: 1 JPY = 9.50 KRW 라면 9.50 입력 · 업데이트 시각: -</p>

    <div class="row">
      <label>방향</label>
      <select id="direction">
        <option value="JPY2KRW">엔 ➜ 원 (JPY → KRW)</option>
        <option value="KRW2JPY">원 ➜ 엔 (KRW → JPY)</option>
      </select>

      <label>반올림 자릿수</label>
      <select id="digits">
        <option value="0">0자리</option>
        <option value="1" selected>1자리</option>
        <option value="2">2자리</option>
      </select>
    </div>

    <div class="row">
      <label>금액 (엔)</label>
      <input id="amount" placeholder="예: 10,000">
      <label>수수료(%)</label>
      <input id="fee" placeholder="예: 1.8">
    </div>

    <div class="row">
      <label>결과</label>
      <input id="result" readonly>
    </div>

    <div>
      <button onclick="copyResult()">결과 복사</button>
      <button onclick="swap()">방향 바꾸기</button>
      <button onclick="resetAll()">초기화</button>
    </div>

    <p class="muted">· 환율 자동 갱신 · 오프라인 시 마지막 값 캐시 · 새 버전 자동 적용</p>
  </div>

  <!-- 패키지 가치 계산 섹션 -->
  <div id="packageSection" class="section">
    <div class="row">
      <label>패키지 가격 (¥)</label>
      <input id="pkgPrice" placeholder="예: 2400">
      <label>유료재화 개수 (마법석)</label>
      <input id="pkgQty" placeholder="예: 20">
    </div>

    <div class="row">
      <label>추가 보상 추정가 (¥)</label>
      <input id="pkgExtra" placeholder="예: 0 (확정캐릭 가치)">
    </div>

    <div class="kpi">
      <div><b>정가 1개당</b>: <span id="vBasePpu">-</span> ¥</div>
      <div><b>패키지 1개당 실효가</b>: <span id="vEffPpu">-</span> ¥</div>
      <div><b>절감액</b>: <span id="vSave">-</span></div>
      <div><b>확정캐릭 추정 가치</b>: <span id="vImpliedExtras">-</span> ¥</div>
    </div>

    <p class="muted">※ "추정 캐릭 가치"는 패키지 가격 − (정가 × 유료재화 개수)로 계산됩니다.</p>
  </div>

  <script>
    // 탭 전환
    const tabExchange = document.getElementById('tabExchange');
    const tabPackage = document.getElementById('tabPackage');
    const exchangeSection = document.getElementById('exchangeSection');
    const packageSection = document.getElementById('packageSection');

    tabExchange.onclick = () => {
      tabExchange.classList.add('active');
      tabPackage.classList.remove('active');
      exchangeSection.classList.add('active');
      packageSection.classList.remove('active');
    };

    tabPackage.onclick = () => {
      tabPackage.classList.add('active');
      tabExchange.classList.remove('active');
      packageSection.classList.add('active');
      exchangeSection.classList.remove('active');
    };

    // 환율 계산
    function calc() {
      const r = parseFloat(rate.value);
      const a = parseFloat(amount.value.replace(/,/g,'')) || 0;
      const f = parseFloat(fee.value) || 0;
      const d = parseInt(digits.value);
      if (!r) return;

      let res = direction.value === 'JPY2KRW' ? a * r : a / r;
      res *= 1 - f / 100;
      result.value = res.toFixed(d);
    }

    rate.oninput = amount.oninput = fee.oninput = calc;
    direction.onchange = digits.onchange = calc;

    // 실시간 환율
    async function getRate() {
      try {
        const res = await fetch('https://api.allorigins.win/raw?url=https://open.er-api.com/v6/latest/JPY');
        const data = await res.json();
        const krw = data.rates.KRW;
        rate.value = krw.toFixed(2);
        document.getElementById('rateInfo').textContent = `예: 1 JPY = ${krw.toFixed(2)} KRW · 업데이트 시각: ${new Date(data.time_last_update_utc).toLocaleString('ko-KR')}`;
        calc();
      } catch {
        alert('환율을 가져오지 못했습니다.');
      }
    }

    // 기타 기능
    function copyResult() {
      navigator.clipboard.writeText(result.value);
      alert('복사되었습니다!');
    }
    function swap() {
      direction.value = direction.value === 'JPY2KRW' ? 'KRW2JPY' : 'JPY2KRW';
      calc();
    }
    function resetAll() {
      rate.value = '';
      amount.value = '';
      fee.value = '';
      result.value = '';
    }

    // 패키지 계산
    function calcPkg() {
      const base = 58.82; // 정가 기준 (85개 5000엔)
      const price = parseFloat(pkgPrice.value) || 0;
      const qty = parseFloat(pkgQty.value) || 0;
      const extra = parseFloat(pkgExtra.value) || 0;

      if (!price || !qty) return;

      const eff = (price - extra) / qty;
      const save = ((base - eff) * qty).toFixed(0);
      const saveRate = (((base - eff) / base) * 100).toFixed(1);
      const impliedExtras = price - (base * qty);

      document.getElementById('vBasePpu').textContent = base.toFixed(2);
      document.getElementById('vEffPpu').textContent = eff.toFixed(2);
      document.getElementById('vSave').textContent = `${save} ¥ / ${saveRate}%`;
      document.getElementById('vImpliedExtras').textContent = impliedExtras.toFixed(0);
    }

    pkgPrice.oninput = pkgQty.oninput = pkgExtra.oninput = calcPkg;

    // 서비스워커 등록 + 자동 새로고침
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        const reg = await navigator.serviceWorker.register('./sw.js');
        reg.update().catch(()=>{});
        setInterval(() => reg.update().catch(()=>{}), 30 * 60 * 1000);
        navigator.serviceWorker.addEventListener('message', e => {
          if (e.data.type === 'NEW_VERSION_READY') setTimeout(()=>location.reload(),200);
        });
        navigator.serviceWorker.addEventListener('controllerchange', ()=>setTimeout(()=>location.reload(),200));
      });
    }
  </script>
</body>
</html>
